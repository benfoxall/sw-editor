<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>sw-editor</title>
    <style media="screen">
      body {
        font-family: sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      label, textarea{
        display: block
      }
      fieldset {
        border: none;
        border-radius: 3px;
        padding:.4em;
        position: relative;
        box-shadow: rgba(0,0,0,0.2) 2px 3px 10px;
        margin:1em;
      }
      textarea {
        border: none;
        margin:0;
        border-radius: 3px;
        width: 100%;
      }
      form {
        margin:1em
      }
    </style>
  </head>
  <body>
    <h1>sw-editor</h1>

    <form id="add">
      <input id="path" name="path" placeholder="/foo.html">
      <select id="type">
        <option value="text/html">html</option>
        <option value="script/javascript">js</option>
        <option value="text/css">css</option>
        <option value="text/text">text</option>
      </select>
      <button>+</button>
    </form>

    <script type="text/javascript">

      navigator.serviceWorker.register('/sw.js')

      function addFile(path, content, type) {

        var input;

        var f = el('fieldset', [
          el('button', [text('×')], {onclick: rm}),
          el('legend', [text(path)]),
          input = el('textarea',[], {onchange: update, rows:8})
        ])

        document.body.appendChild(f)

        if(content) input.value = content

        input.focus()


        function rm() {
          remove(path)
          document.body.removeChild(f)
        }

        function update() {
          put(path, this.value, type)
        }

      }

      add.onsubmit = function(e){
        e.preventDefault()
        addFile(path.value, '', type.value)
        path.value = ''
      }




      // realDOM™
      function el(name, children, props) {

        var element = document.createElement(name)

        if(children)
          children.forEach(function(child){
            element.appendChild(child)
          })

        if(props)
          Object.keys(props).forEach(function(p){
            element[p] = props[p]
          })

        return element
      }

      function text(str){
        return document.createTextNode(str)
      }



      // Storage
      // todo - something reduxy and idb based would
      // be a better way of structuring this to allow
      // follow along and history


      // initial list

      // this feels horrible.
      caches.open('content').then(function(cache) {
        cache.keys()
          .then(function(requests) {
            requests.forEach(function(request) {
              cache.match(request)
                .then(function(response){
                  response.text()
                    .then(function(text){
                      addFile(
                        relative(request.url),
                        text,
                        response.headers.get('Content-Type')
                      )
                    })
                })
            })
          })
      })


      function relative(url) {
        return url.split(location.origin)
            .filter(function(d) {return d})
            [0]
      }


      function put(path, body, type) {
        caches.open('content')
          .then(function(cache) {
            cache.put(path, new Response(body, {
              headers: {
                'Content-Type': type
              }
            }))
          })
      }

      function remove(path) {
        caches.open('content')
          .then(function(cache) {
            cache.delete(path)
          })
      }




    </script>

  </body>
</html>
